2005-12-29  Soeren D. Schulze  <soeren.d.schulze@gmx.de>

	* i386/i386at/model_dep.c (reboot_on_panic) [!MACH_KBD]: New variable.
	(c_boot_entry) [!MACH_KBD]: Set reboot_on_panic to 0 if kernel_cmdline
	contains '-H'.
	* kern/debug.c (panic): Call halt_all_cpus with reboot_on_panic as
	argument.


---
 i386/i386at/model_dep.c |    9 +++++++++
 kern/debug.c            |    6 +++++-
 2 files changed, 14 insertions(+), 1 deletion(-)

--- a/i386/i386at/model_dep.c
+++ b/i386/i386at/model_dep.c
@@ -110,6 +110,10 @@ void		inittodr();	/* forward */
 
 int		rebootflag = 0;	/* exported to kdintr */
 
+#if ! MACH_KBD
+boolean_t reboot_on_panic = 1;
+#endif
+
 /* XX interrupt stack pointer and highwater mark, for locore.S.  */
 vm_offset_t int_stack_top, int_stack_high;
 
@@ -434,6 +438,11 @@ void c_boot_entry(vm_offset_t bi)
 		cninit();		/* need console for debugger */
 		Debugger("init");
 	}
+#else
+	if (strstr (kernel_cmdline, "-H "))
+	  {
+	    reboot_on_panic = 0;
+	  }
 #endif	/* MACH_KDB */
 
 	machine_slot[0].is_cpu = TRUE;
--- a/kern/debug.c
+++ b/kern/debug.c
@@ -126,6 +126,10 @@ panic_init(void)
 	}
 }
 
+#if ! MACH_KBD
+extern boolean_t reboot_on_panic;
+#endif
+
 /*VARARGS1*/
 void
 panic(const char *s, ...)
@@ -167,7 +171,7 @@ panic(const char *s, ...)
 	    delay (1000000);	/* microseconds */
 	}
 
-	halt_all_cpus (1);
+	halt_all_cpus (reboot_on_panic);
 #endif
 }
 
